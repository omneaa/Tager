<<<<<<< HEAD
<<<<<<< HEAD
import { AWSSDKCredentialProvider } from '../../cmap/auth/aws_temporary_credentials';
=======
import { getAwsCredentialProvider } from '../../deps';
>>>>>>> e0024dc8141712765c0830b3ff82b0bad3d52c1e
=======
import { getAwsCredentialProvider } from '../../deps';
>>>>>>> e0024dc8141712765c0830b3ff82b0bad3d52c1e
import { type KMSProviders } from '.';

/**
 * @internal
 */
export async function loadAWSCredentials(kmsProviders: KMSProviders): Promise<KMSProviders> {
<<<<<<< HEAD
<<<<<<< HEAD
  const credentialProvider = new AWSSDKCredentialProvider();

  // We shouldn't ever receive a response from the AWS SDK that doesn't have a `SecretAccessKey`
  // or `AccessKeyId`.  However, TS says these fields are optional.  We provide empty strings
  // and let libmongocrypt error if we're unable to fetch the required keys.
  const {
    SecretAccessKey = '',
    AccessKeyId = '',
    Token
  } = await credentialProvider.getCredentials();
  const aws: NonNullable<KMSProviders['aws']> = {
    secretAccessKey: SecretAccessKey,
    accessKeyId: AccessKeyId
  };
  // the AWS session token is only required for temporary credentials so only attach it to the
  // result if it's present in the response from the aws sdk
  Token != null && (aws.sessionToken = Token);

=======
=======
>>>>>>> e0024dc8141712765c0830b3ff82b0bad3d52c1e
  const credentialProvider = getAwsCredentialProvider();

  if ('kModuleError' in credentialProvider) {
    return kmsProviders;
  }

  const { fromNodeProviderChain } = credentialProvider;
  const provider = fromNodeProviderChain();
  // The state machine is the only place calling this so it will
  // catch if there is a rejection here.
  const aws = await provider();
<<<<<<< HEAD
>>>>>>> e0024dc8141712765c0830b3ff82b0bad3d52c1e
=======
>>>>>>> e0024dc8141712765c0830b3ff82b0bad3d52c1e
  return { ...kmsProviders, aws };
}
